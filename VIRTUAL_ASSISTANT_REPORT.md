# Полный отчёт: Виртуальный помощник платформы изучения казахского языка

## 1. Общее описание

Виртуальный помощник — **правиловой (rule-based)** образовательный чат-бот для платформы интерактивного изучения казахского языка. Работает **без LLM**, использует только данные платформы. Логика полностью объяснима, подходит для дипломной защиты.

---

## 2. Принципы работы

| Принцип | Описание |
|---------|----------|
| **Без чёрного ящика** | Логика построена на явных правилах и шаблонах |
| **Только данные платформы** | Источники: словарь БД, контент уроков, A1-правила |
| **Прослеживаемость** | Каждый ответ ссылается на источник («Из словаря», «Из урока», «Правило A1») |
| **Без ответов на тесты** | В режиме теста не выдаёт правильные ответы |
| **Уровень A1** | Ответы формулируются простым языком |

---

## 3. Источники знаний

Помощник использует **только** следующие источники:

### 3.1. Словарь платформы (Vocabulary)
- Словарь казахско-русских пар из БД (~3000+ слов)
- Поиск по `word_kz` и `translation_ru`
- Приоритет: точное совпадение, затем подстрока
- Выдача: слово, перевод, пример (если есть), статус в личном словаре

### 3.2. Контент уроков (Lesson content)
- Текст урока из БД (разделы: цель, объяснение, примеры, грамматика, частые ошибки)
- Используемые блоки:
  - **Оқу мақсаты / Цель урока** — при запросах «объясни урок», «что понять»
  - **Грамматикалық нүкте** — при грамматических вопросах в контексте урока
  - **Жиі қателер / Частые ошибки** — при вопросах об ошибках

### 3.3. Грамматические правила A1
- Предопределённые правила в коде:
  - **Порядок слов** — подлежащее, дополнение, глагол
  - **Аффиксы** — агглютинация, корень + окончания
  - **Формальность** — сіз/сен, приветствия
  - **Настоящее время** — личные окончания (-мын, -сың и т.д.)
  - **Default** — отсылка к грамматике в уроке

---

## 4. Определение намерения (Intent detection)

Каждое сообщение классифицируется в один из **5 intent**:

### 4.1. vocabulary_question (вопрос о слове)
**Триггеры:** что значит, как переводится, перевод, значение слова, как будет, по-казахски, на казахском, перевести, означает, слово, что такое

**Примеры:**
- «Что значит слово «сәлем»?»
- «Перевод слова жақсы»
- «Как переводится «рақмет»?»

**Поведение:**
- Извлекает слово из кавычек или контекста
- Нормализует написание (рахмет → рақмет, салем → сәлем)
- Ищет в словаре платформы
- Возвращает перевод, пример, статус в личном словаре
- **В режиме теста** — не даёт перевод

### 4.2. grammar_question (грамматический вопрос)
**Триггеры:** грамматик, существительное, глагол, падеж, окончание, почему, как использовать, как сказать, правило, аффикс, суффикс, спряжение, склонение, какой порядок, порядок слов, разница между, в чём разница, объясни урок, объясни про, что понять, должен понять

**Примеры:**
- «Почему используется «мен»?»
- «Какой порядок слов в казахском?»
- «В чём разница между «сәлем» и «сәлеметсіз бе»?»
- «Объясни правило про окончания»
- «Объясни урок про приветствия»

**Поведение:**
- При наличии `lesson_id` — использует контент урока (цель, грамматика)
- Иначе — выбирает правило A1 по ключевым словам
- **В режиме теста** — только общие подсказки, без ответа

### 4.3. error_explanation (объяснение ошибки)
**Триггеры:** подскажи, подсказка, помоги, не понимаю, не получается, ошибся, неправильно, почему не, что не так, объясни ошибку, почему ошибка, хинт, в чём ошибка, моя ошибка, почему неправильно

**Примеры:**
- «Подскажи, не понимаю»
- «В чём моя ошибка?»
- «Почему это неправильно?»

**Поведение:**
- При `lesson_id` — использует раздел «Частые ошибки» урока
- Иначе — общее правило по `last_error_type` (vocabulary, grammar, word_order)
- **Никогда не выдаёт правильный ответ**

### 4.4. general_help (общая помощь)
**Триггеры:** привет, здравствуй, помощь, помогите, как, что, сәлем, приветствую, добрый, hi, hello

**Примеры:**
- «Привет»
- «Помощь»

**Поведение:**
- При `lesson_id` — указывает текущий урок и предлагает задать конкретный вопрос
- Иначе — краткое описание возможностей и примеры

### 4.5. unknown (неизвестный запрос)
**Триггеры:** любые сообщения, не попавшие в другие intent

**Поведение:**
- Сообщение: «Я помогаю объяснять слова, правила грамматики и ошибки из урока. Задайте вопрос о конкретном слове или правиле.»

---

## 5. Режимы контекста (Context modes)

Поведение зависит от `mode` в контексте:

| Режим | Описание | Ограничения |
|-------|----------|-------------|
| **free** | Свободный чат | Полный доступ ко всем ответам |
| **lesson** | Просмотр урока | Учитывается `lesson_id`, ответы строятся с учётом контента урока |
| **vocabulary** | Игра со словами | Аналогично free, можно спрашивать слова |
| **test** | Прохождение теста | **Не даёт переводов и ответов**, только общие подсказки |

---

## 6. Дополнительные функции

### 6.1. Нормализация написания
Исправляются частые варианты:
- рахмет → рақмет  
- салем, салам → сәлем  
- жаксы → жақсы  
- кешириниз → кешіріңіз  
- отынемин → өтінемін  

### 6.2. Извлечение слова
- Приоритет — слово в кавычках «...» или "..."
- Паттерны: «слово X», «что значит X», «перевод слова X»
- Удаление пунктуации (», ?, ! и т.д.)
- Фразы («я студент») — совет задать вопрос об одном слове

### 6.3. Подсказки (Suggestions)
- «Добавить в словарь»
- «Перечитать урок «Название»»
- «Игра со словами», «Уроки»
- Ссылки ведут в соответствующие разделы приложения

---

## 7. API

**Endpoint:** `POST /api/assistant/chat`

**Тело запроса:**
```json
{
  "message": "Что значит сәлем?",
  "context": {
    "lesson_id": 2,
    "lesson_topic": "Приветствия",
    "mode": "free",
    "user_level": "A1",
    "last_error_type": null
  }
}
```

**Ответ:**
```json
{
  "response": "Из словаря платформы: «сәлем» — привет. Можете добавить в личный словарь...",
  "suggestions": ["Добавить в словарь"]
}
```

---

## 8. Примеры запросов и ответов

| Запрос | Intent | Ответ |
|--------|--------|-------|
| «Что значит слово «сәлем»?» | vocabulary_question | Из словаря: «сәлем» — привет |
| «Как переводится «рахмет»?» | vocabulary_question | «рақмет» — спасибо (нормализация) |
| «Почему используется «мен»?» | grammar_question | Правило formal_informal (сіз/сен) |
| «Какой порядок слов в казахском?» | grammar_question | Правило word_order |
| «Объясни урок про приветствия» | grammar_question | Цель урока из контента |
| «Подскажи, не понимаю» + lesson_id | error_explanation | Раздел «Частые ошибки» урока |
| «Привет» | general_help | Описание возможностей |
| «Какая погода завтра?» | unknown | Fallback |

---

## 9. Ограничения

- Не переводит **целые фразы**, только отдельные слова
- Не отвечает на **общие** вопросы (погода, новости и т.п.)
- В **режиме теста** не даёт ответов на вопросы теста
- Поддерживается только **уровень A1**
- Логика основана на **ключах слов**, без семантического понимания

---

## 10. Файлы реализации

| Файл | Назначение |
|------|------------|
| `app/assistant/service.py` | Основная логика, intent, ответы |
| `app/assistant/rules.py` | Паттерны intent, A1-правила |
| `app/assistant/schemas.py` | Модели ChatMessage, ChatResponse |
| `app/assistant/router.py` | API-эндпоинт |
| `app/vocabulary/service.py` | lookup_word, get_user_vocab_status |
| `app/lessons/service.py` | get_lesson_for_assistant |

---

## 11. Резюме

Виртуальный помощник:

- Отвечает на вопросы о **словах** (словарь платформы)
- Объясняет **грамматику** (правила A1 и контент уроков)
- Помогает **после ошибок** (раздел «Частые ошибки», правила)
- Работает с **контекстом** урока и режима (тест/урок/словарь)
- Не даёт ответов во время **теста**
- Нормализует написание и извлекает слово из кавычек
- В ответах указывает источник («Из словаря», «Из урока», «Правило A1»)
